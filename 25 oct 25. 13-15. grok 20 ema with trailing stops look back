//@version=5
strategy("EMA 20 Simple Strategy - Fixed Extremum Stop", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=1, initial_capital=10000)

// Параметры
ema_length = input.int(20, title="EMA Length", minval=1)
lookback = input.int(1, title="Lookback for Extremum Stop", minval=1)

// Расчет EMA
ema20 = ta.ema(close, ema_length)

// Условия для свечей
bullish_prev = close[1] > open[1]  // Предыдущая свеча бычья
bearish_prev = close[1] < open[1]  // Предыдущая свеча медвежья

// Условия входа
long_condition = close > ema20 and bullish_prev
short_condition = close < ema20 and bearish_prev

// Экстремумы для стопов (фиксированные на момент входа, на основе предыдущих баров)
long_stop_level = ta.lowest(low[1], lookback)
short_stop_level = ta.highest(high[1], lookback)

// Вход в лонг: закрываем шорт, если открыт, и входим в лонг с фиксированным стопом
if long_condition
    if strategy.position_size < 0
        strategy.close("Short")
    strategy.entry("Long", strategy.long)
    strategy.exit("Stop Long", from_entry="Long", stop=long_stop_level)  // Фиксированный стоп, не меняется

// Вход в шорт: закрываем лонг, если открыт, и входим в шорт с фиксированным стопом
if short_condition
    if strategy.position_size > 0
        strategy.close("Long")
    strategy.entry("Short", strategy.short)
    strategy.exit("Stop Short", from_entry="Short", stop=short_stop_level)  // Фиксированный стоп, не меняется

// Отображение EMA
plot(ema20, color=color.blue, title="EMA 20", linewidth=2)

// Визуализация стопов (горизонтальные линии для текущей позиции)
plot(strategy.position_size > 0 ? long_stop_level : na, color=color.red, style=plot.style_linebr, title="Long Stop", linewidth=2)
plot(strategy.position_size < 0 ? short_stop_level : na, color=color.green, style=plot.style_linebr, title="Short Stop", linewidth=2)

// Фон для сигналов (опционально, для визуализации)
bgcolor(long_condition ? color.new(color.green, 90) : short_condition ? color.new(color.red, 90) : na)

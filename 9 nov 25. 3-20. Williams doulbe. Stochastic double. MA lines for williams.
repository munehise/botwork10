//@version=6
indicator(title="Multi Stochastic & Williams %R Merged", shorttitle="Multi Stoch & W%R", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// --- Shifts for Levels ---
stoch1_shift = 0
stoch2_shift = 110
will1_shift = 320
will2_shift = 430

// --- Stochastic 1 Inputs ---
periodK1 = input.int(14, title="%K Length", minval=1, group="Stochastic 1 Settings")
smoothK1 = input.int(1, title="%K Smoothing", minval=1, group="Stochastic 1 Settings")
periodD1 = input.int(3, title="%D Smoothing", minval=1, group="Stochastic 1 Settings")

// --- Stochastic 2 Inputs ---
periodK2 = input.int(21, title="%K Length", minval=1, group="Stochastic 2 Settings")
smoothK2 = input.int(3, title="%K Smoothing", minval=1, group="Stochastic 2 Settings")
periodD2 = input.int(3, title="%D Smoothing", minval=1, group="Stochastic 2 Settings")

// --- Williams %R 1 Inputs ---
length1 = input.int(14, title="Length", minval=1, group="Williams %R 1 Settings")
src1 = input(close, "Source", group="Williams %R 1 Settings")

// --- Williams %R 1 Smoothing MA Inputs ---
GRP1 = "Williams %R 1 Smoothing"
maTypeInput1 = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP1)
var isBB1 = maTypeInput1 == "SMA + Bollinger Bands"
maLengthInput1 = input.int(14, "Length", group = GRP1, active = maTypeInput1 != "None")
bbMultInput1 = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands.", group = GRP1, active = isBB1)
var enableMA1 = maTypeInput1 != "None"

// --- Williams %R 2 Inputs ---
length2 = input.int(10, title="Length", minval=1, group="Williams %R 2 Settings")
src2 = input(close, "Source", group="Williams %R 2 Settings")

// --- Williams %R 2 Smoothing MA Inputs ---
GRP2 = "Williams %R 2 Smoothing"
maTypeInput2 = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP2)
var isBB2 = maTypeInput2 == "SMA + Bollinger Bands"
maLengthInput2 = input.int(14, "Length", group = GRP2, active = maTypeInput2 != "None")
bbMultInput2 = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands.", group = GRP2, active = isBB2)
var enableMA2 = maTypeInput2 != "None"

// --- Williams %R Function ---
_pr(src, length) =>
    max_val = ta.highest(src, length)
    min_val = ta.lowest(src, length)
    100 * (src - max_val) / (max_val - min_val)

// --- Stochastic 1 Calculation ---
k1 = ta.sma(ta.stoch(close, high, low, periodK1), smoothK1)
d1 = ta.sma(k1, periodD1)

// --- Stochastic 2 Calculation ---
k2 = ta.sma(ta.stoch(close, high, low, periodK2), smoothK2)
d2 = ta.sma(k2, periodD2)

// --- Williams %R Calculations ---
percentR1 = _pr(src1, length1)
percentR2 = _pr(src2, length2)

// --- Smoothing MA Calculation for Williams %R ---
ma(source, length, MAtype) =>
    switch MAtype
        "SMA"                   => ta.sma(source, length)
        "SMA + Bollinger Bands" => ta.sma(source, length)
        "EMA"                   => ta.ema(source, length)
        "SMMA (RMA)"            => ta.rma(source, length)
        "WMA"                   => ta.wma(source, length)
        "VWMA"                  => ta.vwma(source, length)

// --- Smoothing MA for Williams %R 1 ---
smoothingMA1 = enableMA1 ? ma(percentR1, maLengthInput1, maTypeInput1) : na
smoothingStDev1 = isBB1 ? ta.stdev(percentR1, maLengthInput1) * bbMultInput1 : na
smoothingMA1_shifted = enableMA1 ? smoothingMA1 + will1_shift : na
smoothingStDev1_shifted = enableMA1 ? smoothingStDev1 + will1_shift : na

// --- Smoothing MA for Williams %R 2 ---
smoothingMA2 = enableMA2 ? ma(percentR2, maLengthInput2, maTypeInput2) : na
smoothingStDev2 = isBB2 ? ta.stdev(percentR2, maLengthInput2) * bbMultInput2 : na
smoothingMA2_shifted = enableMA2 ? smoothingMA2 + will2_shift : na
smoothingStDev2_shifted = enableMA2 ? smoothingStDev2 + will2_shift : na

// --- Plots for Stochastic 1 (Level 1: 0-100) ---
plot(k1 + stoch1_shift, title="%K1", color=#2962FF)
plot(d1 + stoch1_shift, title="%D1", color=#FF6D00)
h0_st1 = hline(80 + stoch1_shift, "Stoch1 Upper Band", color=#787B86)
hline(50 + stoch1_shift, "Stoch1 Middle Band", color=color.new(#787B86, 50))
h1_st1 = hline(20 + stoch1_shift, "Stoch1 Lower Band", color=#787B86)
fill(h0_st1, h1_st1, color=color.rgb(33, 150, 243, 90), title="Stoch1 Background")

// --- Plots for Stochastic 2 (Level 2: 110-210) ---
plot(k2 + stoch2_shift, title="%K2", color=#4CAF50)
plot(d2 + stoch2_shift, title="%D2", color=#F44336)
h0_st2 = hline(80 + stoch2_shift, "Stoch2 Upper Band", color=#787B86)
hline(50 + stoch2_shift, "Stoch2 Middle Band", color=color.new(#787B86, 50))
h1_st2 = hline(20 + stoch2_shift, "Stoch2 Lower Band", color=#787B86)
fill(h0_st2, h1_st2, color=color.rgb(76, 175, 80, 90), title="Stoch2 Background")

// --- Plots for Williams %R 1 (Level 3: 220-320) ---
plot(percentR1 + will1_shift, title="%R1", color=#7E57C2)
obPlot1 = hline(-20 + will1_shift, title="W%R1 Upper Band", color=#787B86)
hline(-50 + will1_shift, title="W%R1 Middle Level", linestyle=hline.style_dotted, color=#787B86)
osPlot1 = hline(-80 + will1_shift, title="W%R1 Lower Band", color=#787B86)
fill(obPlot1, osPlot1, title="W%R1 Background", color=color.rgb(126, 87, 194, 90))

// --- Smoothing MA Plots for Williams %R 1 (Shifted) ---
plot(smoothingMA1_shifted, "W%R1-based MA", color=color.yellow, display = enableMA1 ? display.all : display.none)
bbUpperBand1 = plot(smoothingMA1_shifted + smoothingStDev1_shifted, title = "W%R1 Upper Bollinger Band", color=color.green, display = isBB1 ? display.all : display.none)
bbLowerBand1 = plot(smoothingMA1_shifted - smoothingStDev1_shifted, title = "W%R1 Lower Bollinger Band", color=color.green, display = isBB1 ? display.all : display.none)
fill(bbUpperBand1, bbLowerBand1, color= isBB1 ? color.new(color.green, 90) : na, title="W%R1 Bollinger Bands Background Fill", display = isBB1 ? display.all : display.none)

// --- Plots for Williams %R 2 (Level 4: 330-430) ---
plot(percentR2 + will2_shift, title="%R2", color=#9C27B0)
obPlot2 = hline(-20 + will2_shift, title="W%R2 Upper Band", color=#787B86)
hline(-50 + will2_shift, title="W%R2 Middle Level", linestyle=hline.style_dotted, color=#787B86)
osPlot2 = hline(-80 + will2_shift, title="W%R2 Lower Band", color=#787B86)
fill(obPlot2, osPlot2, title="W%R2 Background", color=color.rgb(156, 39, 176, 90))

// --- Smoothing MA Plots for Williams %R 2 (Shifted) ---
plot(smoothingMA2_shifted, "W%R2-based MA", color=color.yellow, display = enableMA2 ? display.all : display.none)
bbUpperBand2 = plot(smoothingMA2_shifted + smoothingStDev2_shifted, title = "W%R2 Upper Bollinger Band", color=color.green, display = isBB2 ? display.all : display.none)
bbLowerBand2 = plot(smoothingMA2_shifted - smoothingStDev2_shifted, title = "W%R2 Lower Bollinger Band", color=color.green, display = isBB2 ? display.all : display.none)
fill(bbUpperBand2, bbLowerBand2, color= isBB2 ? color.new(color.green, 90) : na, title="W%R2 Bollinger Bands Background Fill", display = isBB2 ? display.all : display.none)

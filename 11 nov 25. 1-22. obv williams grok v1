//@version=6
indicator(title="Multi Stochastic, Williams %R & OBV %R Merged", shorttitle="Multi Stoch, W%R & OBV %R", format=format.price, precision=2, timeframe="", timeframe_gaps=true)

// --- Shifts for Levels ---
stoch1_shift = 0
stoch2_shift = 110
will1_shift = 320
will2_shift = 430
will3_shift = 540  // For OBV Williams %R 1
will4_shift = 650  // For OBV Williams %R 2

// --- Stochastic 1 Inputs ---
periodK1 = input.int(14, title="%K Length", minval=1, group="Stochastic 1 Settings")
smoothK1 = input.int(1, title="%K Smoothing", minval=1, group="Stochastic 1 Settings")
periodD1 = input.int(3, title="%D Smoothing", minval=1, group="Stochastic 1 Settings")

// --- Stochastic 2 Inputs ---
periodK2 = input.int(21, title="%K Length", minval=1, group="Stochastic 2 Settings")
smoothK2 = input.int(3, title="%K Smoothing", minval=1, group="Stochastic 2 Settings")
periodD2 = input.int(3, title="%D Smoothing", minval=1, group="Stochastic 2 Settings")

// --- Williams %R 1 Inputs (Price-based) ---
length1 = input.int(14, title="Length", minval=1, group="Williams %R 1 Settings")
src1 = input(close, "Source", group="Williams %R 1 Settings")

// --- Williams %R 1 Smoothing MA Inputs ---
GRP1 = "Williams %R 1 Smoothing"
maTypeInput1 = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP1)
var isBB1 = maTypeInput1 == "SMA + Bollinger Bands"
maLengthInput1 = input.int(14, "Length", group = GRP1, active = maTypeInput1 != "None")
bbMultInput1 = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands.", group = GRP1, active = isBB1)
var enableMA1 = maTypeInput1 != "None"

// --- Williams %R 2 Inputs (Price-based) ---
length2 = input.int(10, title="Length", minval=1, group="Williams %R 2 Settings")
src2 = input(close, "Source", group="Williams %R 2 Settings")

// --- Williams %R 2 Smoothing MA Inputs ---
GRP2 = "Williams %R 2 Smoothing"
maTypeInput2 = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP2)
var isBB2 = maTypeInput2 == "SMA + Bollinger Bands"
maLengthInput2 = input.int(14, "Length", group = GRP2, active = maTypeInput2 != "None")
bbMultInput2 = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands.", group = GRP2, active = isBB2)
var enableMA2 = maTypeInput2 != "None"

// --- OBV Williams %R 1 Inputs ---
obv_length1 = input.int(14, title="OBV Length", minval=1, group="OBV Williams %R 1 Settings")

// --- OBV Williams %R 1 Smoothing MA Inputs ---
GRP3 = "OBV Williams %R 1 Smoothing"
maTypeInput3 = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP3)
var isBB3 = maTypeInput3 == "SMA + Bollinger Bands"
maLengthInput3 = input.int(14, "Length", group = GRP3, active = maTypeInput3 != "None")
bbMultInput3 = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands.", group = GRP3, active = isBB3)
var enableMA3 = maTypeInput3 != "None"

// --- OBV Williams %R 2 Inputs ---
obv_length2 = input.int(10, title="OBV Length", minval=1, group="OBV Williams %R 2 Settings")

// --- OBV Williams %R 2 Smoothing MA Inputs ---
GRP4 = "OBV Williams %R 2 Smoothing"
maTypeInput4 = input.string("None", "Type", options = ["None", "SMA", "SMA + Bollinger Bands", "EMA", "SMMA (RMA)", "WMA", "VWMA"], group = GRP4)
var isBB4 = maTypeInput4 == "SMA + Bollinger Bands"
maLengthInput4 = input.int(14, "Length", group = GRP4, active = maTypeInput4 != "None")
bbMultInput4 = input.float(2.0, "BB StdDev", minval = 0.001, maxval = 50, step = 0.5, tooltip = "Only applies when 'SMA + Bollinger Bands' is selected. Determines the distance between the SMA and the bands.", group = GRP4, active = isBB4)
var enableMA4 = maTypeInput4 != "None"

// --- Williams %R Function ---
_pr(src, length) =>
    max_val = ta.highest(src, length)
    min_val = ta.lowest(src, length)
    100 * (src - max_val) / (max_val - min_val)

// --- OBV Calculation ---
obv = 0.0
obv := nz(obv[1]) + (close > close[1] ? volume : close < close[1] ? -volume : 0)

// --- Stochastic 1 Calculation ---
k1 = ta.sma(ta.stoch(close, high, low, periodK1), smoothK1)
d1 = ta.sma(k1, periodD1)

// --- Stochastic 2 Calculation ---
k2 = ta.sma(ta.stoch(close, high, low, periodK2), smoothK2)
d2 = ta.sma(k2, periodD2)

// --- Williams %R Calculations (Price-based) ---
percentR1 = _pr(src1, length1)
percentR2 = _pr(src2, length2)

// --- OBV-based Williams %R Calculations ---
percentR_obv1 = _pr(obv, obv_length1)
percentR_obv2 = _pr(obv, obv_length2)

// --- Smoothing MA Calculation for Williams %R ---
ma(source, length, MAtype) =>
    switch MAtype
        "SMA"                   => ta.sma(source, length)
        "SMA + Bollinger Bands" => ta.sma(source, length)
        "EMA"                   => ta.ema(source, length)
        "SMMA (RMA)"            => ta.rma(source, length)
        "WMA"                   => ta.wma(source, length)
        "VWMA"                  => ta.vwma(source, length)

// --- Smoothing MA for Williams %R 1 (Price) ---
smoothingMA1 = enableMA1 ? ma(percentR1, maLengthInput1, maTypeInput1) : na
smoothingStDev1 = isBB1 ? ta.stdev(percentR1, maLengthInput1) * bbMultInput1 : na
smoothingMA1_shifted = enableMA1 ? smoothingMA1 + will1_shift : na
smoothingStDev1_shifted = enableMA1 ? smoothingStDev1 + will1_shift : na

// --- Smoothing MA for Williams %R 2 (Price) ---
smoothingMA2 = enableMA2 ? ma(percentR2, maLengthInput2, maTypeInput2) : na
smoothingStDev2 = isBB2 ? ta.stdev(percentR2, maLengthInput2) * bbMultInput2 : na
smoothingMA2_shifted = enableMA2 ? smoothingMA2 + will2_shift : na
smoothingStDev2_shifted = enableMA2 ? smoothingStDev2 + will2_shift : na

// --- Smoothing MA for OBV Williams %R 1 ---
smoothingMA3 = enableMA3 ? ma(percentR_obv1, maLengthInput3, maTypeInput3) : na
smoothingStDev3 = isBB3 ? ta.stdev(percentR_obv1, maLengthInput3) * bbMultInput3 : na
smoothingMA3_shifted = enableMA3 ? smoothingMA3 + will3_shift : na
smoothingStDev3_shifted = enableMA3 ? smoothingStDev3 + will3_shift : na

// --- Smoothing MA for OBV Williams %R 2 ---
smoothingMA4 = enableMA4 ? ma(percentR_obv2, maLengthInput4, maTypeInput4) : na
smoothingStDev4 = isBB4 ? ta.stdev(percentR_obv2, maLengthInput4) * bbMultInput4 : na
smoothingMA4_shifted = enableMA4 ? smoothingMA4 + will4_shift : na
smoothingStDev4_shifted = enableMA4 ? smoothingStDev4 + will4_shift : na

// --- Plots for Stochastic 1 (Level 1: 0-100) ---
plot(k1 + stoch1_shift, title="%K1", color=#2962FF)
plot(d1 + stoch1_shift, title="%D1", color=#FF6D00)
h0_st1 = hline(80 + stoch1_shift, "Stoch1 Upper Band", color=#787B86)
hline(50 + stoch1_shift, "Stoch1 Middle Band", color=color.new(#787B86, 50))
h1_st1 = hline(20 + stoch1_shift, "Stoch1 Lower Band", color=#787B86)
fill(h0_st1, h1_st1, color=color.rgb(33, 150, 243, 90), title="Stoch1 Background")

// --- Plots for Stochastic 2 (Level 2: 110-210) ---
plot(k2 + stoch2_shift, title="%K2", color=#4CAF50)
plot(d2 + stoch2_shift, title="%D2", color=#F44336)
h0_st2 = hline(80 + stoch2_shift, "Stoch2 Upper Band", color=#787B86)
hline(50 + stoch2_shift, "Stoch2 Middle Band", color=color.new(#787B86, 50))
h1_st2 = hline(20 + stoch2_shift, "Stoch2 Lower Band", color=#787B86)
fill(h0_st2, h1_st2, color=color.rgb(76, 175, 80, 90), title="Stoch2 Background")

// --- Plots for Williams %R 1 (Price, Level 3: 320+) ---
plot(percentR1 + will1_shift, title="%R1", color=#7E57C2)
obPlot1 = hline(-20 + will1_shift, title="W%R1 Upper Band", color=#787B86)
hline(-50 + will1_shift, title="W%R1 Middle Level", linestyle=hline.style_dotted, color=#787B86)
osPlot1 = hline(-80 + will1_shift, title="W%R1 Lower Band", color=#787B86)
fill(obPlot1, osPlot1, title="W%R1 Background", color=color.rgb(126, 87, 194, 90))

// --- Smoothing MA Plots for Williams %R 1 ---
plot(smoothingMA1_shifted, "W%R1-based MA", color=color.yellow, display = enableMA1 ? display.all : display.none)
bbUpperBand1 = plot(smoothingMA1_shifted + smoothingStDev1_shifted, title = "W%R1 Upper Bollinger Band", color=color.green, display = isBB1 ? display.all : display.none)
bbLowerBand1 = plot(smoothingMA1_shifted - smoothingStDev1_shifted, title = "W%R1 Lower Bollinger Band", color=color.green, display = isBB1 ? display.all : display.none)
fill(bbUpperBand1, bbLowerBand1, color= isBB1 ? color.new(color.green, 90) : na, title="W%R1 Bollinger Bands Background Fill", display = isBB1 ? display.all : display.none)

// --- Plots for Williams %R 2 (Price, Level 4: 430+) ---
plot(percentR2 + will2_shift, title="%R2", color=#9C27B0)
obPlot2 = hline(-20 + will2_shift, title="W%R2 Upper Band", color=#787B86)
hline(-50 + will2_shift, title="W%R2 Middle Level", linestyle=hline.style_dotted, color=#787B86)
osPlot2 = hline(-80 + will2_shift, title="W%R2 Lower Band", color=#787B86)
fill(obPlot2, osPlot2, title="W%R2 Background", color=color.rgb(156, 39, 176, 90))

// --- Smoothing MA Plots for Williams %R 2 ---
plot(smoothingMA2_shifted, "W%R2-based MA", color=color.yellow, display = enableMA2 ? display.all : display.none)
bbUpperBand2 = plot(smoothingMA2_shifted + smoothingStDev2_shifted, title = "W%R2 Upper Bollinger Band", color=color.green, display = isBB2 ? display.all : display.none)
bbLowerBand2 = plot(smoothingMA2_shifted - smoothingStDev2_shifted, title = "W%R2 Lower Bollinger Band", color=color.green, display = isBB2 ? display.all : display.none)
fill(bbUpperBand2, bbLowerBand2, color= isBB2 ? color.new(color.green, 90) : na, title="W%R2 Bollinger Bands Background Fill", display = isBB2 ? display.all : display.none)

// --- Plots for OBV Williams %R 1 (Level 5: 540+) ---
plot(percentR_obv1 + will3_shift, title="OBV %R1", color=#FF5722)
obPlot3 = hline(-20 + will3_shift, title="OBV W%R1 Upper Band", color=#787B86)
hline(-50 + will3_shift, title="OBV W%R1 Middle Level", linestyle=hline.style_dotted, color=#787B86)
osPlot3 = hline(-80 + will3_shift, title="OBV W%R1 Lower Band", color=#787B86)
fill(obPlot3, osPlot3, title="OBV W%R1 Background", color=color.rgb(255, 87, 34, 90))

// --- Smoothing MA Plots for OBV Williams %R 1 ---
plot(smoothingMA3_shifted, "OBV W%R1-based MA", color=color.yellow, display = enableMA3 ? display.all : display.none)
bbUpperBand3 = plot(smoothingMA3_shifted + smoothingStDev3_shifted, title = "OBV W%R1 Upper Bollinger Band", color=color.green, display = isBB3 ? display.all : display.none)
bbLowerBand3 = plot(smoothingMA3_shifted - smoothingStDev3_shifted, title = "OBV W%R1 Lower Bollinger Band", color=color.green, display = isBB3 ? display.all : display.none)
fill(bbUpperBand3, bbLowerBand3, color= isBB3 ? color.new(color.green, 90) : na, title="OBV W%R1 Bollinger Bands Background Fill", display = isBB3 ? display.all : display.none)

// --- Plots for OBV Williams %R 2 (Level 6: 650+) ---
plot(percentR_obv2 + will4_shift, title="OBV %R2", color=#E91E63)
obPlot4 = hline(-20 + will4_shift, title="OBV W%R2 Upper Band", color=#787B86)
hline(-50 + will4_shift, title="OBV W%R2 Middle Level", linestyle=hline.style_dotted, color=#787B86)
osPlot4 = hline(-80 + will4_shift, title="OBV W%R2 Lower Band", color=#787B86)
fill(obPlot4, osPlot4, title="OBV W%R2 Background", color=color.rgb(233, 30, 99, 90))

// --- Smoothing MA Plots for OBV Williams %R 2 ---
plot(smoothingMA4_shifted, "OBV W%R2-based MA", color=color.yellow, display = enableMA4 ? display.all : display.none)
bbUpperBand4 = plot(smoothingMA4_shifted + smoothingStDev4_shifted, title = "OBV W%R2 Upper Bollinger Band", color=color.green, display = isBB4 ? display.all : display.none)
bbLowerBand4 = plot(smoothingMA4_shifted - smoothingStDev4_shifted, title = "OBV W%R2 Lower Bollinger Band", color=color.green, display = isBB4 ? display.all : display.none)
fill(bbUpperBand4, bbLowerBand4, color= isBB4 ? color.new(color.green, 90) : na, title="OBV W%R2 Bollinger Bands Background Fill", display = isBB4 ? display.all : display.none)

//@version=5
strategy("BB Dynamic Stops 4-Level Matreshka Full (TRAP+MACD3 HARD)", overlay=true, currency=currency.USD, default_qty_type=strategy.cash, default_qty_value=10000, initial_capital=10000)

// === Inputs ===
source = input(close, "Source")
ma_type = input.string("SMA", "Bollinger Basis Type", options=["SMA", "EMA"])
useMACD1 = input.bool(true, "Use MACD J1 Filter")
useMACD2 = input.bool(true, "Use MACD S1 Filter")
useMACD3 = input.bool(true, "Use MACD S2 Filter")

// Junior BB
bb_length_j = input.int(20, "BB Length Junior")
bb_mult_j   = input.float(2.0, "BB Multiplier Junior", minval=0.1, step=0.1)

// Senior BB Levels
bb_length_s1 = input.int(40, "BB Length Senior 1")
bb_mult_s1   = input.float(4.0, "BB Multiplier Senior 1")
bb_length_s2 = input.int(60, "BB Length Senior 2")
bb_mult_s2   = input.float(6.0, "BB Multiplier Senior 2")
bb_length_s3 = input.int(80, "BB Length Senior 3")
bb_mult_s3   = input.float(8.0, "BB Multiplier Senior 3")

// === MACD Inputs ===
fast_j  = input.int(12, "MACD J1 Fast")
slow_j  = input.int(26, "MACD J1 Slow")
fast_s1 = input.int(24, "MACD S1 Fast")
slow_s1 = input.int(52, "MACD S1 Slow")
fast_s2 = input.int(30, "MACD S2 Fast")
slow_s2 = input.int(65, "MACD S2 Slow")

// === Functions ===
alpha(len) => 2 / (len + 1)
macd_level(level, price, fast_len, slow_len) =>
    (level + (1 - alpha(slow_len)) * ta.ema(price, slow_len)[1] - (1 - alpha(fast_len)) * ta.ema(price, fast_len)[1]) / (alpha(fast_len) - alpha(slow_len))

bb_calc(price, length, mult) =>
    basis = ma_type=="SMA"? ta.sma(price, length) : ta.ema(price,length)
    dev   = mult * ta.stdev(price,length)
    [basis, basis+dev, basis-dev]

// === BB Lines ===
[bb_basis_j,  bb_upper_j,  bb_lower_j]  = bb_calc(source, bb_length_j,  bb_mult_j)
[bb_basis_s1, bb_upper_s1, bb_lower_s1] = bb_calc(source, bb_length_s1, bb_mult_s1)
[bb_basis_s2, bb_upper_s2, bb_lower_s2] = bb_calc(source, bb_length_s2, bb_mult_s2)
[bb_basis_s3, bb_upper_s3, bb_lower_s3] = bb_calc(source, bb_length_s3, bb_mult_s3)

// === MACD Zero Lines (3 штуки) ===
macd_j1   = macd_level(0, source, fast_j, slow_j)
macd_s1_1 = macd_level(0, source, fast_s1, slow_s1)
macd_s2_1 = macd_level(0, source, fast_s2, slow_s2)

// === Trap Variables ===
var float trap_j  = na
var bool  bull_j  = false
var float trap_s1 = na
var bool  bull_s1 = false
var float trap_s2 = na
var bool  bull_s2 = false
var float trap_s3 = na
var bool  bull_s3 = false

// === Junior Trap ===
if ta.crossover(high, bb_upper_j)
    bull_j := true
    trap_j := bb_lower_j[1]
if ta.crossunder(low, bb_lower_j)
    bull_j := false
    trap_j := bb_upper_j[1]
trap_j := bull_j ? math.max(na(trap_j)?bb_lower_j:trap_j, bb_lower_j) : math.min(na(trap_j)?bb_upper_j:trap_j, bb_upper_j)

// === Senior Traps ===
if ta.crossover(high, bb_upper_s1)
    bull_s1 := true
    trap_s1 := bb_lower_s1[1]
if ta.crossunder(low, bb_lower_s1)
    bull_s1 := false
    trap_s1 := bb_upper_s1[1]
trap_s1 := bull_s1 ? math.max(na(trap_s1)?bb_lower_s1:trap_s1, bb_lower_s1) : math.min(na(trap_s1)?bb_upper_s1:trap_s1, bb_upper_s1)

if ta.crossover(high, bb_upper_s2)
    bull_s2 := true
    trap_s2 := bb_lower_s2[1]
if ta.crossunder(low, bb_lower_s2)
    bull_s2 := false
    trap_s2 := bb_upper_s2[1]
trap_s2 := bull_s2 ? math.max(na(trap_s2)?bb_lower_s2:trap_s2, bb_lower_s2) : math.min(na(trap_s2)?bb_upper_s2:trap_s2, bb_upper_s2)

if ta.crossover(high, bb_upper_s3)
    bull_s3 := true
    trap_s3 := bb_lower_s3[1]
if ta.crossunder(low, bb_lower_s3)
    bull_s3 := false
    trap_s3 := bb_upper_s3[1]
trap_s3 := bull_s3 ? math.max(na(trap_s3)?bb_lower_s3:trap_s3, bb_lower_s3) : math.min(na(trap_s3)?bb_upper_s3:trap_s3, bb_upper_s3)

// === Background Colors (Trend Filters) ===
bg_green = bull_j and bull_s1 and bull_s2 and bull_s3
bg_red   = not bull_j and not bull_s1 and not bull_s2 and not bull_s3

// === MACD Filters ===
macdUp1   = source > macd_j1
macdDown1 = source < macd_j1
macdUp2   = source > macd_s1_1
macdDown2 = source < macd_s1_1
macdUp3   = source > macd_s2_1
macdDown3 = source < macd_s2_1

macd_filter_up   = (not useMACD1 or macdUp1) and (not useMACD2 or macdUp2) and (not useMACD3 or macdUp3)
macd_filter_down = (not useMACD1 or macdDown1) and (not useMACD2 or macdDown2) and (not useMACD3 or macdDown3)

// === Entry Conditions Based on BG Color ===
color_long_entry  = bg_green and not bg_green[1] and macd_filter_up
color_short_entry = bg_red and not bg_red[1] and macd_filter_down

// MACD entries while BG correct
macd_long_entry  = bg_green and macd_filter_up and not macd_filter_up[1]
macd_short_entry = bg_red and macd_filter_down and not macd_filter_down[1]

// Combined entries
full_long  = color_long_entry or macd_long_entry
full_short = color_short_entry or macd_short_entry

// === Exit Conditions Based on BG Color ===
exitLong  = not bg_green
exitShort = not bg_red

// === Strategy Execution ===
if full_long and strategy.position_size <= 0
    strategy.entry("Long", strategy.long)

if full_short and strategy.position_size >= 0
    strategy.entry("Short", strategy.short)

if exitLong and strategy.position_size > 0
    strategy.close("Long")

if exitShort and strategy.position_size < 0
    strategy.close("Short")

// === Plotting Bollinger Bands ===
plot(bb_upper_j, "BB Up Junior", color=color.green)
plot(bb_lower_j, "BB Low Junior", color=color.green)
plot(bb_basis_j, "BB Mid Junior", color=color.gray)

plot(bb_upper_s1, "BB Up S1", color=color.orange)
plot(bb_lower_s1, "BB Low S1", color=color.orange)

plot(bb_upper_s2, "BB Up S2", color=color.blue)
plot(bb_lower_s2, "BB Low S2", color=color.blue)

plot(bb_upper_s3, "BB Up S3", color=color.purple)
plot(bb_lower_s3, "BB Low S3", color=color.purple)

// === Plotting Traps ===
plot(trap_j,  "Trap Junior", color=color.lime, linewidth=2)
plot(trap_s1, "Trap S1",     color=color.red, linewidth=2)
plot(trap_s2, "Trap S2",     color=color.aqua, linewidth=2)
plot(trap_s3, "Trap S3",     color=color.fuchsia, linewidth=2)

// === MACD Lines ===
plot(useMACD1 ? macd_j1   : na, "MACD J1",   color=color.gray)
plot(useMACD2 ? macd_s1_1 : na, "MACD S1_1", color=color.red)
plot(useMACD3 ? macd_s2_1 : na, "MACD S2_1", color=color.blue)

// === Background and Bar Coloring ===
bgcolor(bg_green ? color.new(color.green, 80) :
       bg_red ? color.new(color.red, 80) :
       color.new(color.gray, 80), title="Trap Zone Background")

barcolor(bg_green ? color.new(color.green, 0) :
         bg_red ? color.new(color.red, 0) :
         color.new(color.gray, 50))

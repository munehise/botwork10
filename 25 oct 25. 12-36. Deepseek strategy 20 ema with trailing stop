// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Grizzly_Pitt

//@version=5
strategy("Grizzly's 20 EMA Strategy with Stop", overlay=true, margin_long=100, margin_short=100, initial_capital=1000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// Параметры
emaLength = input.int(20, "EMA Length")

// Расчет индикаторов
ema20 = ta.ema(close, emaLength)
prevBullish = close[1] > open[1]
prevBearish = close[1] < open[1]

// Условия входа
longCondition = close > ema20 and prevBullish
shortCondition = close < ema20 and prevBearish

// Стоп-лоссы на экстремумах предыдущего бара
longStop = low[1]
shortStop = high[1]

// Исполнение стратегии
if (longCondition)
    strategy.entry("Long", strategy.long)
    strategy.exit("Long Exit", "Long", stop=longStop)
    
if (shortCondition)
    strategy.entry("Short", strategy.short)
    strategy.exit("Short Exit", "Short", stop=shortStop)

// Визуализация
plot(ema20, color=color.blue, linewidth=2, title="20 EMA")

// Отображение стоп-уровней
plot(strategy.position_size > 0 ? longStop : na, color=color.red, style=plot.style_circles, linewidth=2, title="Long Stop")
plot(strategy.position_size < 0 ? shortStop : na, color=color.red, style=plot.style_circles, linewidth=2, title="Short Stop")

// Зоны входа
bgcolor(longCondition ? color.new(color.green, 95) : na)
bgcolor(shortCondition ? color.new(color.red, 95) : na)
